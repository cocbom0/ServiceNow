<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>false</applies_req_item>
        <applies_sc_task>false</applies_sc_task>
        <applies_target_record>false</applies_target_record>
        <applies_to>item</applies_to>
        <cat_item display_value="Customer articles">894d4fb81b1f89905b1b411acd4bcb93</cat_item>
        <cat_variable/>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>false</isolate_script>
        <messages/>
        <name>onSubmit : Has attachment - display_atta</name>
        <order/>
        <script><![CDATA[var attachmentAndTextManagementComplete = false;
var versionManagementComplete = false;
var updateSerialNumberComplete = false;

function onSubmit() {
    if (g_form.ajaxComplete) {
        setMetaField();
        return true;
    }
    attachmentAndTextManagement();
    versionManagement();
	updateSerialNumberData();
    return false;
}

function complete(processNumber) {
    switch (processNumber) {
        case 1:
            attachmentAndTextManagementComplete = true;
            break;
        case 2:
            versionManagementComplete = true;
            break;
		case 3:
			updateSerialNumberComplete = true;
			break;
        default:
            break;
    }

		if (attachmentAndTextManagementComplete &&
			versionManagementComplete &&
			updateSerialNumberComplete) {
        g_form.ajaxComplete = true;
        g_form.submit();
    }
}

function attachmentAndTextManagement() {
    if (this.document.getElementsByClassName('get-attachment').length !== 0) {
        g_form.setValue("display_attachments", "Yes");
        textManagement();
    } else {
        g_form.setValue("display_attachments", "No");
        complete(1);
    }
}

function textManagement() {
    var ga = "";
    ga = new GlideAjax("GetLastAttachmentSysIdByUser");
    ga.addParam("sysparm_name", "getAttachmentSysId");
    ga.addParam("user", g_user.userName);
    ga.getXMLAnswer(setText);
}

function setText(response) {
    var result = "";
    if (response) {
        result = JSON.parse(response);
        g_form.setValue("text", "<iframe width=\"960\" height=\"540\" src=\"" + getEnvironnment() + "$viewer.do?sysparm_stack=no&sysparm_sys_id=" + result.sys_id + "\"></iframe>");
    } else {
        g_form.setValue("text", "");
    }
    complete(1);
}

function versionManagement() {
    var ga = "";
    var article = g_form.getValue("article");

    if (article) {
        ga = new GlideAjax("CreateNewArticleVersion");
        ga.addParam("sysparm_name", "createArticleVersion");
        ga.addParam("article", article);
        ga.addParam("user", g_user.userName);
        ga.addParam("version", g_form.getValue("version"));
        ga.getXMLAnswer(setVersion);
    } else {
        complete(2);
    }
}

function setVersion(response) {
    var result = "";
    if (response) {
        result = JSON.parse(response);
        g_form.setValue("version", result.version);
    } else {
        g_form.setValue("version", "");
    }
    complete(2);
}

function getEnvironnment() {
    var result = "";

    var pattern = "^(https:\/\/liebherr)([a-z]*)(\.service-now\.com\/)";
    var regex = new RegExp(pattern);
    var results = regex.exec(top.location.href);

    if (results !== null) {
        result = results[1] + results[2] + results[3];
    }

    return result;
}

function setMetaField() {
    g_form.setValue("meta", [
        g_form.getValue("meta"),
        g_form.getDisplayValue("serial_number"),
        g_form.getDisplayValue("commissioning_reason"),
        g_form.getValue("commissioning_date"),
        g_form.getValue("commissioning_location"),
        g_form.getValue("equipment_sn"),
        g_form.getValue("equipment_operating_hours"),
        g_form.getValue("name_of_the_person_submitting_the_form"),
        g_form.getValue("name_of_the_person_acknowledging_the_form")
    ].join(", "));
}

function updateSerialNumberData() {
	if(g_form.getValue("io_commissioning_reports") == "Yes") {
		var ga = new GlideAjax("UpdateSerialNumber");
		ga.addParam("sysparm_name", "updateSerialNumber");
		ga.addParam("serial_number", getSerialNumber());
        ga.addParam("commissioning_reason", g_form.getValue("commissioning_reason"));
		ga.addParam("commissioning_date", g_form.getValue("commissioning_date"));
		ga.addParam("commissioning_location", g_form.getValue("commissioning_location"));
		ga.addParam("equipment_sn", g_form.getValue("equipment_sn"));
		ga.addParam("equipment_operating_hours", g_form.getValue("equipment_operating_hours"));
		ga.addParam("name_of_the_person_submitting_the_form", g_form.getValue("name_of_the_person_submitting_the_form"));
		ga.addParam("name_of_the_person_acknowledging_the_form", g_form.getValue("name_of_the_person_acknowledging_the_form"));
		ga.getXMLAnswer(function(response) {
			complete(3);
		});
	} else {
		complete(3);
	}
}

function getSerialNumber() {
	var serialNumber = "";
	
	var pattern = "^([0-9]){10}(?=[ -])*";
	var regex = new RegExp(pattern);
    var results = regex.exec(g_form.getDisplayValue("serial_number"));

    if (results !== null) {
        serialNumber = results[0];
    }

    return serialNumber;
}]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>cockrl0</sys_created_by>
        <sys_created_on>2022-06-01 15:45:39</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>7b74c1c21bff0d905b1b411acd4bcbbf</sys_id>
        <sys_mod_count>40</sys_mod_count>
        <sys_name>onSubmit : Has attachment - display_atta</sys_name>
        <sys_overrides/>
        <sys_package display_value="Support case" source="x_liisa_support_ca">80d47c06dba7f05001eafad3f3961926</sys_package>
        <sys_policy/>
        <sys_scope display_value="Support case">80d47c06dba7f05001eafad3f3961926</sys_scope>
        <sys_update_name>catalog_script_client_7b74c1c21bff0d905b1b411acd4bcbbf</sys_update_name>
        <sys_updated_by>cockrl0</sys_updated_by>
        <sys_updated_on>2023-02-22 17:15:52</sys_updated_on>
        <table/>
        <type>onSubmit</type>
        <ui_type>10</ui_type>
        <variable_set/>
        <view/>
    </catalog_script_client>
</record_update>
